---
layout: post
title: "Windows AD渗透之黄金白银票据"
date: "2021-11-19"
description: "Penetration"
tag: 内网渗透
--- 

## 提前:

&emsp;&emsp;涉及windows服务器平台，AD域控，帐号体系的问题，关键字包含: AD、KDC、

&emsp;

## 原理
&emsp;&emsp;首先科普一下域控知识，域控是什么，有什么作用，在渗透测试中把它定位于哪个角色。

&emsp;&emsp;域控是什么呢？简单来说它就是一个账号认证与服务管理系统，它把其它服务器(打印机、web服务、邮件系统等)加入它的管理范围内，当其它人想使用这些服务时，也必需加入它的管控，这样有什么好处呢，这样的好处就是一个账号可以使用所有它能管到的服务,它可以统一下发杀毒软件，可以统一配置安全策略，是不是在管理多台服务器或多个服务时很方便。


给张逻辑图:
![](./images/posts/AD_images/ad.jpg)


&emsp;

## 核心内容
关键词:krbtgt账号、 黄金票据(Golden ticket)、白银票据(Silver tickets)

&emsp;

先放图(网上复制的, 但个人觉得比较通俗易懂):

![](./images/posts/AD_images/tickets.jpg)

&emsp;&emsp;上图你可以理解左边就是办公网的pc、笔记本等，右边就是AD，它有很多模块，此Authenticatio Server、ticket granting server是它的认证模块，server是它管理的服务器或服务，这里我们个人与火车站系统来类比，大概分为三个阶段：
* 第一阶段：我要坐火车，我拿身份证给火车站(此为图中的authentication server)验证，火车站验证通过，给了张临时凭证(TGT)给你去另一个窗口办理(Ticket granting server)

* 第二阶段：你拿着TGT凭证来到另一个窗口(Ticket granting server)并说我要做火车，此时它会验证你的TGT凭证，表明你就是你(哈哈)，此时它给你一张ST票，并让你去几号台上火车

* 第三阶段：你来到xxx号站台，你把ST票给门口那个人，然后你说我要坐火车，他拿着票看了下，票上写着xxx车箱xxx座位，通过后，你就可以上火车了。

&emsp;

理解上面的东西后，重点来了：

&emsp;如果我把第一阶段得到的TGT内容改了，改成领导的名字，然后再发给(Ticket granting server)，通过了以后是不是以他的权限享受更好的服务呢？你要伪造这个票据，你得知道他们怎么加密这张票的，而这张票就是我们所说的黄金票据，通过修改它可以用不同人的身份做不同的事，访问不同的数据。

&emsp;&emsp;这个时候就不得不提krbtgt这个账号了，上面所说的TGT票据就是这个账号的信息来加密的，由此可推出只要得到了这个账号的信息，我们就可以伪造任意TGT票据，达到为所欲为的目的。

&emsp;&emsp;那么白银票据呢？其实就是修改(Ticket granting server)发给你的st票据，而st票据也是用krbtgt这个账号的信息加密的，因此也得需要获得krbtgt账号信息。

&emsp;

<font color=red>重中之重的东西来了:</font>

&emsp;&emsp;为什么这么好的技术用的人少呢？搞域控那不是一把梭的问题么？有想过么？

<font color=red>&emsp;&emsp;原因是伪造票据是需要krbtgt这个账号信息，这个账号是装AD的时候产生的账号，且不可登录，你没AD管理员权限或好的机遇(这个账号信息被管理员抓下来放在了某个地方,然后被你发现了)，那么你就没办法伪造这些票据，你有域管的权限并登录域控，那么你就可以抓这个账号的信息，这时候你不觉得有这样的权限我还需要抓这个账号的信息？</font>


&emsp;
## 总结
&emsp;&emsp;最后总结一下，技术是好技术，技巧也是好技巧，多一个渗透技巧也多一个路子，只不过你要去理解他们测试成功的一些前提条件，免得在实际安全测试中都没法成功(出错也是成功的好帮手)。


&emsp;
## 参考文献
非常原理性的文章：https://daiker.gitbook.io/windows-protocol/